events {}

http {
  # 로컬 전략: 앱은 호스트(IDE)에서 실행.
  # 따라서 nginx 컨테이너는 host.docker.internal 로 호스트 앱에 접근.
  upstream taskflow_app {
    server host.docker.internal:8080;
  }

  upstream taskflow_mgmt {
    # 관리 포트(Actuator 전용). 아래 Spring 설정에서 8081로 분리
    server host.docker.internal:8081;
  }

  server {
    listen 80;

    # 일반 요청 -> 호스트의 앱(8080)
    location / {
      proxy_pass http://taskflow_app;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 로컬에서는 health/info 정도만 열어둔다 (mgmt 포트로 프록시)
    location = /actuator/health {
      proxy_pass http://taskflow_mgmt/actuator/health;
    }

    location = /actuator/info {
      proxy_pass http://taskflow_mgmt/actuator/info;
    }

    # 그 외 actuator는 차단
    location /actuator/ {
      deny all;
      return 403;
    }
  }
}
